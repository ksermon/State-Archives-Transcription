{% extends 'base.html' %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/fileview.css') }}" />
{% endblock extra_css%}

{% block content %}
  <div class="main-box">
    <h1 class="file-title">File: {{ name }}</h1>
    <div class="description-block">
      <p class="description">Description: {{ description }}</p>
    </div>

    <!-- Adds message when document is being processed -->
    {% if processing %}
      <div class="processing-message" style="color: #FF8888; background: #2B1A1A; padding: 1.5em; border-radius: 8px; text-align: center; font-size: 1.2em; margin: 2em 0;">
        <strong>This document is still being processed. Please wait</strong>
      </div>
      <div style="text-align: center; margin: 1em 0;">
        <div id="processing-progress-container" style="width: 100%; max-width: 600px; margin: 0 auto; background: #444; border-radius: 8px;">
          <!-- Progress bar, same as file upload -->
          <div id="processing-progress-bar" style="width: 0%; height: 18px; background: #4caf50; border-radius: 8px; transition: width 0.3s;"></div>
        </div>
        <span id="processing-progress-text" style="display: block; margin-top: 10px; font-size: 1rem; color: #ccc;">Checking progress...</span>
        </div> 
    {% else %}
      <div class="container" style="display: flex; gap: 40px;">
        <div class="ocr-image-box" style="flex: 1; text-align: center;">
          <img src="data:image/png;base64,{{ image }}" alt="Page image" style="max-width: 100%; height: auto;" />
          <div class="pdf-controller" style="margin-top:10px;">
            {% if page > 1 %}
              <a href="{{ url_for('main.file_view', file_id=file_id, page=page-1) }}">
                <button type="button">&laquo; Prev</button>
              </a>
            {% else %}
              <button type="button" disabled>&laquo; Prev</button>
            {% endif %}
            <span style="align-self: center; background: none; border: none; box-shadow: none; color: #fff; font-size: 1rem; margin: 0 0.5rem;">Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
              <a href="{{ url_for('main.file_view', file_id=file_id, page=page+1) }}">
                <button type="button">Next &raquo;</button>
              </a>
            {% else %}
              <button type="button" disabled>Next &raquo;</button>
            {% endif %}
          </div>
        </div>
        <div class="ocr-transcription-box" style="flex: 1;">
    <div class="viewer-editor">
      <div class="pdf-viewer">
<div class="pdf-stage-wrapper">
  {% if image_dimensions %}
    {% set aspect = (image_dimensions.height / image_dimensions.width * 100) %}
  {% else %}
    {% set aspect = None %}
  {% endif %}

  <div class="pdf-overlay">
    <div class="overlay-group zoom-controls">
      <button type="button" class="icon-btn" id="zoom-out" aria-label="Zoom out">&#8722;</button>
      <button type="button" class="icon-btn" id="zoom-in" aria-label="Zoom in">&#43;</button>
      <button type="button" class="icon-btn" id="reset-view" aria-label="Fit page">&#9974;</button>
    </div>
    <div class="overlay-group page-controls">
      {% if page > 1 %}
        <a class="icon-btn" href="{{ url_for('main.file_view', file_id=file_id, page=page-1) }}" aria-label="Previous page">&laquo;</a>
      {% else %}
        <span class="icon-btn disabled" aria-hidden="true">&laquo;</span>
      {% endif %}
      <span class="page-indicator">{{ page }} / {{ total_pages }}</span>
      {% if page < total_pages %}
        <a class="icon-btn" href="{{ url_for('main.file_view', file_id=file_id, page=page+1) }}" aria-label="Next page">&raquo;</a>
      {% else %}
        <span class="icon-btn disabled" aria-hidden="true">&raquo;</span>
      {% endif %}
    </div>
  </div>

  <div id="pdf-stage" class="pdf-stage" {% if aspect %}style="--pdf-aspect: {{ '%.2f'|format(aspect) }}%;"{% endif %}>
    <img id="pdf-image" src="data:image/png;base64,{{ image }}" alt="Page image" />
    <div id="highlight-overlay" class="highlight-overlay"></div>
  </div>
</div>
      </div>

      <div class="transcription-panel">
        <div class="panel-header">
          <h3>Transcription</h3>
          <div style="white-space: pre-wrap;">{{ transcription }}</div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Progress bar document processing -->
  {% if processing %}
  <script>
  // Auto-refresh progress for documents being processed
  let processingInterval = null;
  
  function checkProcessingProgress() {
    fetch('{{ url_for("main.file_processing_status", file_id=file_id) }}')
      .then(response => response.json())
      .then(data => {
        if (data.total && data.processed !== undefined) {
          const percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
          document.getElementById('processing-progress-bar').style.width = percent + '%';
          document.getElementById('processing-progress-text').textContent = 
            `${data.processed}/${data.total} pages processed`;
          
          // If all pages are processed, reload the page
          if (data.processed >= data.total && data.total > 0) {
            clearInterval(processingInterval);
            document.getElementById('processing-progress-text').textContent = 'Processing complete! Reloading...';
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        }
      })
      .catch(error => {
        console.error('Progress check error:', error);
      });
  }
  
  // Check progress every 1 second
  processingInterval = setInterval(checkProcessingProgress, 1000);
  // Check immediately on load
  checkProcessingProgress();
  </script>
  {% endif %}
{% endblock %}