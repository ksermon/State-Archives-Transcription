{% extends 'base.html' %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/fileview.css') }}" />
{% endblock extra_css%}

{% block content %}
  <div class="main-box">
    <div class="page-header">
      <div>
        <h1 class="file-title">File: {{ name }}</h1>
        <p class="description">{{ description }}</p>
      </div>
      <div class="header-actions">
        <a class="btn" href="{{ url_for('main.download_transcription', file_id=file_id) }}">Download Text</a>
      </div>
    </div>

    <div class="viewer-editor">
      <div class="pdf-viewer">
        <div class="pdf-stage-wrapper">
          <div class="pdf-overlay">
            <div class="overlay-group zoom-controls">
              <button type="button" class="icon-btn" id="zoom-out" aria-label="Zoom out">&#8722;</button>
              <button type="button" class="icon-btn" id="zoom-in" aria-label="Zoom in">&#43;</button>
              <button type="button" class="icon-btn" id="reset-view" aria-label="Fit page">&#9974;</button>
            </div>
            <div class="overlay-group page-controls">
              {% if page > 1 %}
                <a class="icon-btn" href="{{ url_for('main.file_view', file_id=file_id, page=page-1) }}" aria-label="Previous page">&laquo;</a>
              {% else %}
                <span class="icon-btn disabled" aria-hidden="true">&laquo;</span>
              {% endif %}
              <span class="page-indicator">{{ page }} / {{ total_pages }}</span>
              {% if page < total_pages %}
                <a class="icon-btn" href="{{ url_for('main.file_view', file_id=file_id, page=page+1) }}" aria-label="Next page">&raquo;</a>
              {% else %}
                <span class="icon-btn disabled" aria-hidden="true">&raquo;</span>
              {% endif %}
            </div>
          </div>
          {% if image_dimensions %}
            {% set aspect = (image_dimensions.height / image_dimensions.width * 100) %}
          {% else %}
            {% set aspect = None %}
          {% endif %}
          <div id="pdf-stage" class="pdf-stage" {% if aspect %}style="--pdf-aspect: {{ '%.2f'|format(aspect) }}%;"{% endif %}>
            <canvas id="pdf-canvas" class="pdf-canvas" aria-label="Document page"></canvas>
            <div id="highlight-overlay" class="highlight-overlay"></div>
          </div>
        </div>
      </div>

      <div class="transcription-panel">
        <div class="panel-header">
          <h3>Transcription</h3>
          <button type="button" id="save-transcription" disabled>Save changes</button>
        </div>
        <p class="panel-subtitle">Double-click a line or use the pencil icon to edit. Click elsewhere to keep the change.</p>
        <div class="transcription-helper">
          <div id="transcription-lines" class="transcription-lines"></div>
        </div>
        <textarea id="transcription-editor" spellcheck="false" hidden>{{ transcription }}</textarea>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script>
    window.FILEVIEW_CONFIG = {
      lineBoxes: {{ line_boxes | tojson }},
      fileId: {{ file_id }},
      pageNumber: {{ page }},
      pdfUrl: "{{ url_for('main.stream_file_pdf', file_id=file_id) }}",
      pdfWorkerSrc: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js"
    };
  </script>
  <script src="{{ url_for('static', filename='js/fileview.js') }}"></script>
{% endblock %}
